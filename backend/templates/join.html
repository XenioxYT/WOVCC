{% extends "layout.html" %}

{% block title %}Join - WOVCC | Wickersley Old Village Cricket Club{% endblock %}

{% block description %}Join our club - Annual membership for just £15/year{% endblock %}

{% block extra_js %}
<script>
(function() {
  // Initialize immediately if DOM is already loaded, otherwise wait
  function initJoinPage() {
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.get('canceled') === 'true') {
      if (typeof showNotification === 'function') {
        showNotification('Payment was canceled. Please try again if you\'d like to join.', 'warning');
      }
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    // Setup form handler
    setupSignupForm();
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initJoinPage);
  } else {
    initJoinPage();
  }
  
  // Listen for page transitions
  document.addEventListener('pageTransitionComplete', function(e) {
    if (e.detail.path === '/join') {
      initJoinPage();
    }
  });
  
  // Handle new member signup
  function setupSignupForm() {
    const form = document.getElementById('signup-form');
    if (!form) return;
    
    // Remove any existing listener by cloning
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    newForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const newsletter = document.getElementById('newsletter').checked;
      
      if (password.length < 6) {
        if (typeof showNotification === 'function') {
          showNotification('Password must be at least 6 characters', 'error');
        } else {
          alert('Password must be at least 6 characters');
        }
        return;
      }
      
      // Disable form
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';
      
      try {
        // Register user - creates pending registration and redirects to Stripe
        const result = await window.WOVCCAuth.signup(name, email, password, newsletter);
        
        if (result.success && result.checkout_url) {
          // Redirect to Stripe Checkout
          window.location.href = result.checkout_url;
          return; // browser will navigate away
        } else {
          if (typeof showNotification === 'function') {
            showNotification(result.message || 'Failed to start registration. Please try again.', 'error');
          } else {
            alert(result.message || 'Failed to start registration. Please try again.');
          }
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      } catch (error) {
        if (typeof showNotification === 'function') {
          showNotification('Failed to connect to server. Please try again.', 'error');
        } else {
          alert('Failed to connect to server. Please try again.');
        }
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  }
})(); // End IIFE
</script>
{% endblock %}

{% block content %}
  <!-- Page Header -->
  <section class="hero" style="background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('/assets/banner.webp'); background-size: cover; background-position: center 40%; height: 300px;">
    <div class="hero-content">
      <h1>Join WOVCC</h1>
      <p>Become a member of our club</p>
    </div>
  </section>

  <!-- Membership Section -->
  <section class="section">
    <div class="container">
      <div style="max-width: 600px; margin: 0 auto;">
        
        <!-- Membership Card -->
        <div class="card" id="membership-card" style="text-align: center; padding: 40px 30px; margin-bottom: 40px;">
          <h2 style="color: var(--primary-color); margin-bottom: 20px;">Annual Membership</h2>
          <div style="font-size: 3rem; font-weight: 700; color: var(--accent-color); margin-bottom: 20px;">
            £15<span style="font-size: 1.2rem; color: var(--text-light);">/year</span>
          </div>
          
          <div style="text-align: left; margin: 30px auto; max-width: 350px;">
            <h4 style="color: var(--primary-color); margin-bottom: 15px;">Benefits:</h4>
            <ul style="list-style: none; padding: 0;">
              <li style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                ✓ Drink discounts at the bar
              </li>
              <li style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                ✓ Access to members area
              </li>
              <li style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                ✓ Support the club
              </li>
              <li style="padding: 8px 0;">
                ✓ Newsletter updates
              </li>
            </ul>
          </div>
        </div>

        <!-- Signup Form -->
        <div id="new-member-form" class="signup-form">
          <h3 style="color: var(--primary-color); margin-bottom: 20px;">Sign Up</h3>
          
          <form id="signup-form">
            <div class="form-group">
              <label class="form-label" for="name">Full Name</label>
              <input type="text" id="name" class="form-input" required>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="email">Email Address</label>
              <input type="email" id="email" class="form-input" required>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="password">Create Password</label>
              <input type="password" id="password" class="form-input" required>
            </div>
            
            <div class="form-group">
              <div class="form-checkbox">
                <input type="checkbox" id="newsletter" name="newsletter">
                <label for="newsletter">Receive club news and updates via email</label>
              </div>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">
              Pay £15 & Join
            </button>
            
            <p class="text-center mt-2" style="color: var(--text-light); font-size: 0.9rem;">
              Need help? Contact us at <a href="mailto:info@wovcc.co.uk" style="color: var(--primary-color);">info@wovcc.co.uk</a>
            </p>
          </form>
        </div>

      </div>
    </div>
  </section>
{% endblock %}
