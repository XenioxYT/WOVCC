{% extends "layout.html" %}

{% block title %}Join - WOVCC | Wickersley Old Village Cricket Club{% endblock %}

{% block description %}Join our club - Annual membership for just ¬£15/year{% endblock %}

{% block extra_js %}
<script>
(function() {
  // Initialize immediately if DOM is already loaded, otherwise wait
  function initJoinPage() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Handle successful payment - redirect to activation page
    if (urlParams.get('success') === 'true') {
      window.location.href = '/join/activate';
      return; // Don't setup form, we're leaving this page
    }
    
    if (urlParams.get('canceled') === 'true') {
      if (typeof showNotification === 'function') {
        showNotification('Payment was canceled. Please try again if you\'d like to join.', 'warning');
      }
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    // Setup form handler
    setupSignupForm();
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initJoinPage);
  } else {
    initJoinPage();
  }
  
  // Listen for page transitions
  document.addEventListener('pageTransitionComplete', function(e) {
    if (e.detail.path === '/join') {
      initJoinPage();
    }
  });
  
  // Handle new member signup
  function setupSignupForm() {
    const form = document.getElementById('signup-form');
    if (!form) {
      return;
    }
    
    // Remove any existing listener by cloning
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    newForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const newsletter = document.getElementById('newsletter').checked;
      
      if (password.length < 6) {
        if (typeof showNotification === 'function') {
          showNotification('Password must be at least 6 characters', 'error');
        } else {
          alert('Password must be at least 6 characters');
        }
        return;
      }
      
      // Disable form
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';
      
      try {
        // Register user - creates pending registration and redirects to Stripe
        const result = await window.WOVCCAuth.signup(name, email, password, newsletter);
        
        if (result.success && result.checkout_url) {
          // Redirect to Stripe Checkout
          window.location.href = result.checkout_url;
          return; // browser will navigate away
        } else {
          if (typeof showNotification === 'function') {
            showNotification(result.message || 'Failed to start registration. Please try again.', 'error');
          } else {
            alert(result.message || 'Failed to start registration. Please try again.');
          }
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      } catch (error) {
        if (typeof showNotification === 'function') {
          showNotification('Failed to connect to server. Please try again.', 'error');
        } else {
          alert('Failed to connect to server. Please try again.');
        }
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  }
})(); // End IIFE
</script>
{% endblock %}

{% block content %}
  <!-- Page Header -->
  <section class="hero page-hero">
    <div class="hero-content">
      <h1>Join WOVCC</h1>
      <p>Be part of something special - support your local cricket club</p>
    </div>
  </section>

  <!-- Membership Section -->
  <section class="section">
    <div class="container">
      <div class="join-grid">
        
        <!-- Membership Info Card -->
        <div class="card" id="membership-card" style="padding: 40px 30px;">
          <h2 style="color: var(--primary-color); margin-bottom: 20px; text-align: center;">Annual Membership</h2>
          
          <p style="font-size: 1.05rem; line-height: 1.7; color: var(--text-dark); margin-bottom: 30px; text-align: center;">
            Join WOVCC and become part of our community. Your membership supports the club and provides you with benefits including drink discounts at the bar.
          </p>
          
          <div style="margin-bottom: 30px; text-align: center; padding: 20px; background: var(--secondary-bg); border-radius: 8px;">
            <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-color); margin-bottom: 10px;">
              ¬£15
            </div>
            <p style="color: var(--text-dark); font-size: 0.95rem; margin: 0;">
              Initial membership fee<br>
              <span style="color: var(--text-light); font-size: 0.9rem;">Then ¬£10 annually to renew</span>
            </p>
          </div>
          
          <div>
            <h4 style="color: var(--primary-color); margin-bottom: 20px; font-size: 1.1rem;">Membership Benefits:</h4>
            <ul style="list-style: none; padding: 0;">
              <li style="padding: 12px 0; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px;">
                <span style="color: var(--primary-color); font-size: 1.2rem;">üç∫</span>
                <span style="color: var(--text-dark); font-size: 0.95rem;">Drink discounts at the bar</span>
              </li>
              <li style="padding: 12px 0; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px;">
                <span style="color: var(--primary-color); font-size: 1.2rem;">üí≥</span>
                <span style="color: var(--text-dark); font-size: 0.95rem;">Top up your card at the tills</span>
              </li>
              <li style="padding: 12px 0; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px;">
                <span style="color: var(--primary-color); font-size: 1.2rem;">‚ù§Ô∏è</span>
                <span style="color: var(--text-dark); font-size: 0.95rem;">Support your local club</span>
              </li>
              <li style="padding: 12px 0; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px;">
                <span style="color: var(--primary-color); font-size: 1.2rem;">üîí</span>
                <span style="color: var(--text-dark); font-size: 0.95rem;">Access to members area</span>
              </li>
              <li style="padding: 12px 0; display: flex; align-items: center; gap: 12px;">
                <span style="color: var(--primary-color); font-size: 1.2rem;">üìß</span>
                <span style="color: var(--text-dark); font-size: 0.95rem;">Club news and updates</span>
              </li>
            </ul>
          </div>
        </div>

        <!-- Signup Form -->
        <div id="new-member-form" class="card signup-form">
          <h3 style="color: var(--primary-color); margin-bottom: 20px;">Sign Up</h3>
          
          <form id="signup-form">
            <div class="form-group">
              <label class="form-label" for="name">Full Name</label>
              <input type="text" id="name" class="form-input" required>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="email">Email Address</label>
              <input type="email" id="email" class="form-input" required>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="password">Create Password</label>
              <input type="password" id="password" class="form-input" required>
            </div>
            
            <div class="form-group">
              <div class="form-checkbox">
                <input type="checkbox" id="newsletter" name="newsletter">
                <label for="newsletter">Receive club news and updates via email</label>
              </div>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">
              Continue to Payment
            </button>
            
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
              <p style="color: var(--text-light); font-size: 0.95rem; margin-bottom: 12px;">
                Already have an account?
              </p>
              <a href="/members" class="btn btn-outline" style="padding: 10px 24px;">
                Login to Members Area
              </a>
            </div>
            
            <p class="text-center mt-2" style="color: var(--text-light); font-size: 0.9rem; margin-top: 20px;">
              Need help? Contact us at <a href="mailto:info@wovcc.co.uk" style="color: var(--primary-color);">info@wovcc.co.uk</a>
            </p>
          </form>
        </div>

      </div>
    </div>
  </section>
{% endblock %}
